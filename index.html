<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MAPA DE APORTES</title>

  <!-- estilos -->
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
  <link rel="stylesheet" href="css/qgis2web.css">
  <link rel="stylesheet" href="css/fontawesome-all.min.css">
  <link rel="stylesheet" href="css/leaflet.photon.css">
  <link rel="stylesheet" href="css/styles.css">

  <style>
    html, body, #map { height:100%; margin:0; padding:0; }

    #aporte-count {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
      display: block;
    }

    .aporte-item {
      font-size: 14px;
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- scripts -->
  <script src="js/leaflet.js"></script>
  <script src="js/leaflet.photon.js"></script>
  <script src="js/L.Control.Layers.Tree.min.js"></script>
  <script src="data/MANZANAS_1.js"></script>
  <script src="data/MANZANAS_3.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  // ===========================
  // CONFIGURACI√ìN SUPABASE
  // ===========================
  const SUPABASE_URL = "https://rgoycahzlpmzumxrpzby.supabase.co"; // üëà pon tu URL
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnb3ljYWh6bHBtenVteHJwemJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzMwNTksImV4cCI6MjA3NDQwOTA1OX0.dsJr6NT429WXI_qZFjGISl0512t3CX9PPjeWmMPHSUE"; // üëà pon tu anon key
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const FEATURE_ID_PROP = 'MANZANA';

  var map = L.map('map', { attributionControl: false, zoomControl: false, maxZoom:28, minZoom:1 })
              .fitBounds([[-2.46807,-79.2979],[-2.46714,-79.2959]]);
  L.control.zoom({ position: 'topleft' }).addTo(map);
  L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}').addTo(map);

  // ===========================
  // FUNCIONES SUPABASE
  // ===========================
  async function getAllCommentsByPolygon(fid){
      const { data, error } = await supabase
        .from('aportes')
        .select('*')
        .eq('polygon_id', fid);
      if(error){ console.error(error); return []; }
      return data;
  }

  async function getApprovedComments(fid){
      const { data, error } = await supabase
        .from('aportes')
        .select('*')
        .eq('polygon_id', fid)
        .eq('status', 'approved');
      if(error){ console.error(error); return []; }
      return data;
  }

  async function savePending(comment){
      const { data, error } = await supabase.from('aportes').insert([comment]);
      if(error){ console.error(error); }
      return data;
  }

  function uid(){ return 'c_'+Date.now()+'_'+Math.random().toString(36).slice(2,9); }

  async function getUserIP() {
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      return data.ip;
    } catch (err) {
      console.error("No se pudo obtener la IP", err);
      return null;
    }
  }

  // ===========================
  // FORMULARIO DE APORTES
  // ===========================
  async function commentFormHTML(props){
      var fid = props && props[FEATURE_ID_PROP] ? props[FEATURE_ID_PROP] : '';
      var todos = await getAllCommentsByPolygon(fid);
      var total = todos.length;
      var aprobados = await getApprovedComments(fid);

      var aprobadosHTML = aprobados.map(it => `
        <div class="aporte-item">
          <strong>${it.name || 'An√≥nimo'}</strong><br>
          ${it.comment}
        </div>
      `).join("");

      if(!aprobadosHTML) aprobadosHTML = "<p>No hay aportes publicados a√∫n.</p>";

      return `
      <div class="comment-popup">
          <div class="comment-header">
              <span id="aporte-count"># ${total} APORTES</span>
          </div>
          <div class="aportes-aprobados">
              ${aprobadosHTML}
          </div>
          <hr>
          <form id="comment-form">
              <label class="label">Tu nombre (opcional)</label>
              <input id="comment-name" placeholder="Tu nombre" />
              <label class="label">Escribe tu aporte</label>
              <textarea id="comment-text" required></textarea>
              <label class="label">Adjuntar archivos</label>
              <div class="file-input-wrapper">
                <input type="file" id="comment-files" multiple />
                <small class="file-hint">Selecciona uno o varios archivos</small>
              </div>
              <div class="form-actions">
                  <button type="submit" class="btn-primary">Enviar para revisi√≥n</button>
              </div>
              <input type="hidden" id="comment-fid" value="${fid}" />
          </form>
          <div id="comment-feedback" class="comment-feedback"></div>
      </div>`;
  }

  async function openCommentPopup(props,latlng){
      var content = await commentFormHTML(props);
      L.popup({maxWidth:400,className:'custom-comment-popup'})
        .setLatLng(latlng).setContent(content).openOn(map);

      setTimeout(()=>{
          document.getElementById('comment-form').addEventListener('submit',ev=>{
              ev.preventDefault(); submitComment(props,latlng);
          });
      },50);
  }

  function readFiles(fileList){
      var files = Array.from(fileList||[]);
      return Promise.all(files.map(f=>new Promise(res=>{
          var r=new FileReader();
          r.onload=e=>res({name:f.name,type:f.type,size:f.size,data:e.target.result});
          r.onerror=()=>res(null);
          r.readAsDataURL(f);
      }))).then(a=>a.filter(Boolean));
  }

  async function submitComment(props,latlng){
      var name=document.getElementById('comment-name').value.trim();
      var txt=document.getElementById('comment-text').value.trim();
      var fid=document.getElementById('comment-fid').value;
      var filesInput=document.getElementById('comment-files');
      var fb=document.getElementById('comment-feedback');
      if(!txt){ fb.textContent='Escribe un aporte'; fb.classList.add('error'); return; }

      fb.textContent='Procesando...';
      const files = await readFiles(filesInput.files);
      const ip = await getUserIP();

      const newComment = {
          id: uid(),
          polygon_id: fid,
          name,
          comment: txt,
          files,
          created_at: new Date().toISOString(),
          status: 'pending',
          ip_address: ip
      };

      await savePending(newComment);
      const todos = await getAllCommentsByPolygon(fid);
      document.getElementById('aporte-count').textContent = `# ${todos.length} APORTES`;

      fb.textContent='Aporte enviado (pendiente de revisi√≥n)';
      fb.classList.remove('error'); fb.classList.add('success');
  }

  // ===========================
  // MAPA Y EVENTOS
  // ===========================
  function onEach(feature,layer){ layer.on('click',e=>openCommentPopup(feature.properties,e.latlng)); }
  L.geoJson(json_MANZANAS_1,{onEachFeature:onEach, style:()=>({color:'rgba(35,35,35,0.645)',weight:1,fillColor:'rgba(152,125,183,0.645)',fillOpacity:1})}).addTo(map);
  L.geoJson(json_MANZANAS_3,{onEachFeature:onEach, style:()=>({color:'rgba(35,35,35,0.626)',weight:1,fillColor:'rgba(255,16,0,0.626)',fillOpacity:1})}).addTo(map);

  // Rosa de los vientos (NORTE)
  var north = L.control({ position: "topright" });
  north.onAdd = function (map) {
      var div = L.DomUtil.create("div", "north-control leaflet-control");
      div.innerHTML = '<img src="img/NORTE.png" alt="Norte">';
      return div;
  };
  north.addTo(map);

  // MAPA DE APORTES (T√≠tulo)
  var title = new L.Control({position:'topleft'});
  title.onAdd = function(map) {
      this._div = L.DomUtil.create('div','info map-title');
      this._div.innerHTML = '<h2>MAPA DE APORTES</h2>';
      return this._div;
  };
  title.addTo(map);

  var footer = new L.Control({position:'bottomright'});
  footer.onAdd = function(map) {
      this._div = L.DomUtil.create('div','leaflet-control footer');
      this._div.innerHTML = '2025';
      return this._div;
  };
  footer.addTo(map);
  </script>
</body>
</html>
